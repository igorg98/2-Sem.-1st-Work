Я сдался и собрал через алфавит. Особо ничего нового там нет, но удалось побороть перенос строки, сделав его по-человечески.
